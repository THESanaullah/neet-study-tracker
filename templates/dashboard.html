{% extends "base.html" %}

{% block title %}Dashboard - NEET Study Tracker{% endblock %}

{% block extra_css %}
<style>
/* Move inline styles to proper CSS */
.welcome-section {
    margin-bottom: 2rem;
}

.pomodoro-timer-card {
    margin-top: 2rem;
}

.timer-subject-select {
    max-width: 300px;
    margin: 0 auto 2rem;
}

.subject-progress-section {
    margin-top: 2rem;
}

.subject-progress-grid {
    margin-top: 1rem;
}

.chapter-tracker-section {
    margin-top: 3rem;
}

.subject-tabs {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.chapter-body-padding-reset {
    padding: 0;
}

.revision-alert-section {
    margin-top: 2rem;
}

.chapter-actions {
    margin-top: 0.5rem;
}

.progress-mt {
    margin-top: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="welcome-section">
    <h1>Welcome back, {{ current_user.username }}! üëã</h1>
    <p class="text-muted">Here's your NEET preparation overview</p>
</div>

<!-- Stats Overview -->
<div class="dashboard-grid">
    <div class="stat-card" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);">
        <h3>Overall Progress</h3>
        <div class="stat-value">{{ overall_progress }}%</div>
        {% set total_chapters = (physics_chapters|length) + (chemistry_chapters|length) + (biology_chapters|length) %}
        <div class="stat-label">{{ total_chapters }} total chapters</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <h3>Study This Week</h3>
        <div class="stat-value">{{ total_study_time_week }}h</div>
        <div class="stat-label">Total study time</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
        <h3>Study Streak</h3>
        <div class="stat-value">{{ study_streak }} üî•</div>
        <div class="stat-label">Consecutive days</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <h3>Pomodoros Today</h3>
        <div class="stat-value">{{ pomodoro_count_today }}</div>
        <div class="stat-label">Focus sessions completed</div>
    </div>
</div>

<!-- Pomodoro Timer Section -->
<div class="card pomodoro-timer-card">
    <div class="card-header">
        <h3 class="card-title">‚è±Ô∏è Pomodoro Timer</h3>
    </div>
    <div class="card-body">
        <div class="pomodoro-container">
            <div id="timer-status" class="timer-status text-primary">Focus Time</div>
            <div class="timer-display" id="timer-display">25:00</div>
            
            <div class="form-group timer-subject-select">
                <label for="timer-subject" class="form-label">Subject (Optional)</label>
                <select id="timer-subject" class="form-control">
                    <option value="">Select subject</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Biology">Biology</option>
                </select>
            </div>
            
            <div class="timer-controls">
                <button id="start-btn" class="btn btn-success btn-lg">Start</button>
                <button id="pause-btn" class="btn btn-warning btn-lg" disabled>Pause</button>
                <button id="reset-btn" class="btn btn-danger btn-lg">Reset</button>
            </div>
            
            <div class="timer-stats">
                <p><strong>Today's Sessions:</strong> <span id="today-count">{{ pomodoro_count_today }}</span></p>
                <p><strong>Current Cycle:</strong> <span id="cycle-count">0</span> / 4</p>
            </div>
        </div>
    </div>
</div>

<!-- Subject Progress -->
<div class="subject-progress-section">
    <h2>üìä Subject-wise Progress</h2>
    <div class="dashboard-grid subject-progress-grid">
        <div class="card">
            <div class="card-body">
                <h4>Physics</h4>
                <div class="progress-label">
                    <span>Progress</span>
                    <span>{{ physics_progress }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" style="width: {{ physics_progress }}%;">{{ physics_progress }}%</div>
                </div>
                <p class="text-muted progress-mt">{{ physics_chapters|length }} chapters</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h4>Chemistry</h4>
                <div class="progress-label">
                    <span>Progress</span>
                    <span>{{ chemistry_progress }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" style="width: {{ chemistry_progress }}%; background: linear-gradient(90deg, #10b981, #059669);">{{ chemistry_progress }}%</div>
                </div>
                <p class="text-muted progress-mt">{{ chemistry_chapters|length }} chapters</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h4>Biology</h4>
                <div class="progress-label">
                    <span>Progress</span>
                    <span>{{ biology_progress }}%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" style="width: {{ biology_progress }}%; background: linear-gradient(90deg, #f59e0b, #d97706);">{{ biology_progress }}%</div>
                </div>
                <p class="text-muted progress-mt">{{ biology_chapters|length }} chapters</p>
            </div>
        </div>
    </div>
</div>

<!-- Chapters Needing Revision Alert -->
{% if chapters_need_revision > 0 %}
<div class="alert alert-warning revision-alert-section">
    <strong>‚ö†Ô∏è Reminder:</strong> {{ chapters_need_revision }} chapter(s) haven't been revised in over 7 days. 
    <a href="{{ url_for('revision') }}">View revision tracker ‚Üí</a>
</div>
{% endif %}

<!-- Chapter Tracker Tabs -->
<div class="chapter-tracker-section">
    <h2>üìö Chapter Tracker</h2>
    
    <!-- Subject Tabs -->
    <div class="subject-tabs">
        <button class="btn btn-primary" onclick="showSubject('physics')">Physics ({{ physics_chapters|length }})</button>
        <button class="btn btn-outline" onclick="showSubject('chemistry')">Chemistry ({{ chemistry_chapters|length }})</button>
        <button class="btn btn-outline" onclick="showSubject('biology')">Biology ({{ biology_chapters|length }})</button>
    </div>
    
    <!-- Physics Chapters -->
    <div id="physics-chapters" class="subject-chapters">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Physics Chapters</h3>
            </div>
            <div class="card-body chapter-body-padding-reset">
                <ul class="chapter-list">
                    {% for chapter in physics_chapters %}
                    <li class="chapter-item" data-chapter-id="{{ chapter.id }}" data-subject="Physics">
                        <div class="chapter-header">
                            <span class="chapter-name">{{ loop.index }}. {{ chapter.chapter_name }}</span>
                            {% if chapter.revision_count > 0 %}
                                <span class="revision-badge">{{ chapter.revision_count }}√ó revised</span>
                            {% endif %}
                        </div>
                        <div class="chapter-checkboxes">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="ncert_read"
                                       id="ncert_p{{ chapter.id }}"
                                       {% if chapter.ncert_read %}checked{% endif %}>
                                <label class="form-check-label" for="ncert_p{{ chapter.id }}">üìñ Read NCERT</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="lecture_watched"
                                       id="lecture_p{{ chapter.id }}"
                                       {% if chapter.lecture_watched %}checked{% endif %}>
                                <label class="form-check-label" for="lecture_p{{ chapter.id }}">üé• Watched Lecture</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="questions_solved"
                                       id="questions_p{{ chapter.id }}"
                                       {% if chapter.questions_solved %}checked{% endif %}>
                                <label class="form-check-label" for="questions_p{{ chapter.id }}">‚úçÔ∏è Solved Questions</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="revised"
                                       id="revised_p{{ chapter.id }}"
                                       {% if chapter.revised %}checked{% endif %}>
                                <label class="form-check-label" for="revised_p{{ chapter.id }}">üîÑ Revised</label>
                            </div>
                        </div>
                        <div class="chapter-actions">
                            <button class="btn btn-sm btn-secondary log-revision-btn" 
                                    data-chapter-id="{{ chapter.id }}"
                                    data-chapter-name="{{ chapter.chapter_name }}">
                                Log Revision
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Chemistry Chapters -->
    <div id="chemistry-chapters" class="subject-chapters" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Chemistry Chapters</h3>
            </div>
            <div class="card-body chapter-body-padding-reset">
                <ul class="chapter-list">
                    {% for chapter in chemistry_chapters %}
                    <li class="chapter-item" data-chapter-id="{{ chapter.id }}" data-subject="Chemistry">
                        <div class="chapter-header">
                            <span class="chapter-name">{{ loop.index }}. {{ chapter.chapter_name }}</span>
                            {% if chapter.revision_count > 0 %}
                                <span class="revision-badge">{{ chapter.revision_count }}√ó revised</span>
                            {% endif %}
                        </div>
                        <div class="chapter-checkboxes">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="ncert_read"
                                       id="ncert_c{{ chapter.id }}"
                                       {% if chapter.ncert_read %}checked{% endif %}>
                                <label class="form-check-label" for="ncert_c{{ chapter.id }}">üìñ Read NCERT</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="lecture_watched"
                                       id="lecture_c{{ chapter.id }}"
                                       {% if chapter.lecture_watched %}checked{% endif %}>
                                <label class="form-check-label" for="lecture_c{{ chapter.id }}">üé• Watched Lecture</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="questions_solved"
                                       id="questions_c{{ chapter.id }}"
                                       {% if chapter.questions_solved %}checked{% endif %}>
                                <label class="form-check-label" for="questions_c{{ chapter.id }}">‚úçÔ∏è Solved Questions</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="revised"
                                       id="revised_c{{ chapter.id }}"
                                       {% if chapter.revised %}checked{% endif %}>
                                <label class="form-check-label" for="revised_c{{ chapter.id }}">üîÑ Revised</label>
                            </div>
                        </div>
                        <div class="chapter-actions">
                            <button class="btn btn-sm btn-secondary log-revision-btn" 
                                    data-chapter-id="{{ chapter.id }}"
                                    data-chapter-name="{{ chapter.chapter_name }}">
                                Log Revision
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Biology Chapters -->
    <div id="biology-chapters" class="subject-chapters" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Biology Chapters</h3>
            </div>
            <div class="card-body chapter-body-padding-reset">
                <ul class="chapter-list">
                    {% for chapter in biology_chapters %}
                    <li class="chapter-item" data-chapter-id="{{ chapter.id }}" data-subject="Biology">
                        <div class="chapter-header">
                            <span class="chapter-name">{{ loop.index }}. {{ chapter.chapter_name }}</span>
                            {% if chapter.revision_count > 0 %}
                                <span class="revision-badge">{{ chapter.revision_count }}√ó revised</span>
                            {% endif %}
                        </div>
                        <div class="chapter-checkboxes">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="ncert_read"
                                       id="ncert_b{{ chapter.id }}"
                                       {% if chapter.ncert_read %}checked{% endif %}>
                                <label class="form-check-label" for="ncert_b{{ chapter.id }}">üìñ Read NCERT</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="lecture_watched"
                                       id="lecture_b{{ chapter.id }}"
                                       {% if chapter.lecture_watched %}checked{% endif %}>
                                <label class="form-check-label" for="lecture_b{{ chapter.id }}">üé• Watched Lecture</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="questions_solved"
                                       id="questions_b{{ chapter.id }}"
                                       {% if chapter.questions_solved %}checked{% endif %}>
                                <label class="form-check-label" for="questions_b{{ chapter.id }}">‚úçÔ∏è Solved Questions</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input chapter-checkbox" 
                                       data-chapter-id="{{ chapter.id }}" 
                                       data-type="revised"
                                       id="revised_b{{ chapter.id }}"
                                       {% if chapter.revised %}checked{% endif %}>
                                <label class="form-check-label" for="revised_b{{ chapter.id }}">üîÑ Revised</label>
                            </div>
                        </div>
                        <div class="chapter-actions">
                            <button class="btn btn-sm btn-secondary log-revision-btn" 
                                    data-chapter-id="{{ chapter.id }}"
                                    data-chapter-name="{{ chapter.chapter_name }}">
                                Log Revision
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Subject tab switching
function showSubject(subject) {
    // Hide all subject sections
    var sections = document.querySelectorAll('.subject-chapters');
    for (var i = 0; i < sections.length; i++) {
        sections[i].style.display = 'none';
    }
    
    // Show selected subject
    document.getElementById(subject + '-chapters').style.display = 'block';
    
    // Update button states
    var buttons = document.querySelectorAll('button[onclick^="showSubject"]');
    for (var j = 0; j < buttons.length; j++) {
        buttons[j].classList.remove('btn-primary');
        buttons[j].classList.add('btn-outline');
    }
    event.target.classList.remove('btn-outline');
    event.target.classList.add('btn-primary');
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/timer.js') }}"></script>
{% endblock %}
