{% extends "admin/admin_base.html" %}

{% block title %}View User Progress - {{ user.username }} - Admin Panel{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{{ url_for('manage_users') }}" class="btn btn-outline">‚Üê Back to Users</a>
    <h1 style="margin-top: 1rem;">User Progress: {{ user.username }}</h1>
    <p class="text-muted">Read-only view of user's study dashboard</p>
</div>
<!-- Add this near the top where user info is displayed -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        <h2>User: {{ user.username }}</h2>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Status:</strong> 
            {% if user.is_active %}
                <span class="badge badge-success">Active</span>
            {% else %}
                <span class="badge badge-warning">Inactive</span>
            {% endif %}
        </p>
        
        <!-- ADD THIS SECTION -->
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="{{ url_for('admin_reset_user_password', user_id=user.id) }}" 
               class="btn btn-warning btn-sm">
                üîê Reset Password
            </a>
            
            <form method="POST" action="{{ url_for('admin_generate_temp_password', user_id=user.id) }}" 
                  style="display: inline;">
                <button type="submit" class="btn btn-secondary btn-sm"
                        onclick="return confirm('Generate temporary password for {{ user.username }}?');">
                    üîÑ Generate Temp Password
                </button>
            </form>
        </div>
    </div>
</div>

<!-- User Info Card -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3 class="card-title">üë§ User Information</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div>
                <p><strong>Username:</strong> {{ user.username }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <p><strong>Full Name:</strong> {{ user.full_name or 'Not provided' }}</p>
            </div>
            <div>
                <p><strong>Target NEET Year:</strong> {{ user.target_exam_year or 'Not specified' }}</p>
                <p><strong>Registered:</strong> {{ user.created_at.strftime('%d %B %Y') }}</p>
                <p><strong>Last Login:</strong> {{ user.last_login.strftime('%d %B %Y') if user.last_login else 'Never' }}</p>
            </div>
            <div>
                <p><strong>Account Status:</strong> 
                    {% if user.is_active %}
                        <span class="badge badge-success">Active</span>
                    {% else %}
                        <span class="badge badge-warning">Inactive</span>
                    {% endif %}
                </p>
                <p><strong>Approved By:</strong> {{ user.approved_by_id or 'Not yet approved' }}</p>
                <p><strong>Approved On:</strong> {{ user.approved_at.strftime('%d %B %Y') if user.approved_at else '-' }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Progress Overview -->
<div class="dashboard-grid">
    <div class="stat-card" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);">
        <h3>Overall Progress</h3>
        <div class="stat-value">{{ overall_progress }}%</div>
        <div class="stat-label">{{ physics_chapters|length + chemistry_chapters|length + biology_chapters|length }} total chapters</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
        <h3>Physics</h3>
        <div class="stat-value">{{ physics_progress }}%</div>
        <div class="stat-label">{{ physics_chapters|length }} chapters</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <h3>Chemistry</h3>
        <div class="stat-value">{{ chemistry_progress }}%</div>
        <div class="stat-label">{{ chemistry_chapters|length }} chapters</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
        <h3>Biology</h3>
        <div class="stat-value">{{ biology_progress }}%</div>
        <div class="stat-label">{{ biology_chapters|length }} chapters</div>
    </div>
</div>

<!-- Recent Test Scores -->
{% if recent_tests|length > 0 %}
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title">üìù Recent Test Scores</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Test Name</th>
                        <th>Score</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test in recent_tests %}
                    <tr>
                        <td>{{ test.test_date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ test.test_name }}</td>
                        <td>{{ test.total_score }} / {{ test.total_marks }}</td>
                        <td>
                            {% if test.percentage >= 80 %}
                                <span class="badge badge-success">{{ test.percentage }}%</span>
                            {% elif test.percentage >= 60 %}
                                <span class="badge badge-warning">{{ test.percentage }}%</span>
                            {% else %}
                                <span class="badge badge-danger">{{ test.percentage }}%</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Study Sessions -->
{% if recent_study|length > 0 %}
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title">üìÖ Recent Study Sessions</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Subject</th>
                        <th>Duration</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_study %}
                    <tr>
                        <td>{{ log.date.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if log.subject %}
                                <span class="badge badge-primary">{{ log.subject }}</span>
                            {% else %}
                                <span class="text-muted">All subjects</span>
                            {% endif %}
                        </td>
                        <td>{{ log.duration_minutes }} min ({{ "%.1f"|format(log.duration_minutes / 60) }} hrs)</td>
                        <td>{{ log.notes or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
